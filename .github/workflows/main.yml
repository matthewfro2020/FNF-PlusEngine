# This is a basic workflow to help you get started with Actions

name: Build


# Controls when the action will run.
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ main, experimental ]
  pull_request:
    branches: [ main, experimental ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  buildLinux:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4.1.7

      - uses: krdlab/setup-haxe@master
        with:
          haxe-version: 4.3.4
      # Runs a set of commands using the runners shell
      - name: Install Haxelib
        run: |
          sudo apt-get install libvlc-dev
          sudo apt-get install libvlccore-dev
          haxelib setup ~/haxelib
          haxelib install hxcpp > /dev/null --quiet
          chmod +x ./setup/unish-lib.sh
          sh ./setup/unish-lib.sh
      - name: Skip SScript setup mode
        run: |
          echo -n 'oy9:showMacroty8:loopCosti25y10:includeAllfg' > ~/settings.cocoa
          cat ~/settings.cocoa
      - name: Create Version Tag
        run: echo "${{github.run_id}}" > VERSION
      - name: Compile
        run: haxelib run lime build Project.xml linux --app-version="4.0.0-${{ github.run_id}}" -D officialBuild
      - name: Publish Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: linuxBuild
          path: 'export/release/linux/bin'
          
  buildWindows:
    runs-on: windows-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4.1.7

      - uses: krdlab/setup-haxe@master
        with:
          haxe-version: 4.3.4
      # Runs a set of commands using the runners shell
      - name: Install Haxelib
        run: |
          haxelib setup C:/haxelib
          haxelib install hxcpp > /dev/null --quiet
          .\"setup/windows-lib.bat"
        shell: cmd
      - name: Skip SScript setup mode
        run: |
          echo oy9:showMacroty8:loopCosti25y10:includeAllfg > %USERPROFILE%\settings.cocoa
          type %USERPROFILE%\settings.cocoa
        shell: cmd
      - name: Create Version Tag
        run: echo "${{github.run_id}}" > VERSION
      - name: Compile
        run: haxelib run lime build windows --app-version="4.0.0-${{ github.run_id}}"  -D officialBuild
      - name: Publish Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: windowsBuild
          path: export/release/windows/bin

# Build macOS version (disabled for now for incompatibility issues)
  # buildMac:
    #runs-on: macos-15

    #steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      #- uses: actions/checkout@v4.1.7

      #- uses: krdlab/setup-haxe@master
        #with:
          #haxe-version: 4.3.4
      # Runs a set of commands using the runners shell
      #- name: Install Haxelib
        #run: |
          #haxelib setup ~/haxelib
          #chmod +x ./setup/unish-lib.sh
          #sh ./setup/unish-lib.sh
      #- name: Skip SScript setup mode
        #run: echo 'oy9:showMacroty8:loopCosti25y10:includeAllfg' >> ~/settings.cocoa
      #- name: Create Version Tag
        #run: echo "${{github.run_id}}" > VERSION
      #- name: Compile
        #run: haxelib run lime build mac --app-version="4.0.0-${{ github.run_id}}"  -D officialBuild
      #- name: Publish Artifact
        #uses: actions/upload-artifact@v4.3.4
        #with:
          #name: macBuild
          #path: export/release/macos/bin

  buildAndroid:
    runs-on: ubuntu-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4.1.7

      - uses: krdlab/setup-haxe@master
        with:
          haxe-version: 4.3.4
      
      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Android SDK 35 and NDK r27d
        run: |
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platforms;android-35" "build-tools;35.0.0" "ndk;27.0.12077973" "cmdline-tools;latest"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.0.12077973" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/27.0.12077973" >> $GITHUB_ENV
      
      # Runs a set of commands using the runners shell
      - name: Install Haxelib
        run: |
          haxelib setup ~/haxelib
          haxelib install hxcpp > /dev/null --quiet
          chmod +x ./setup/unish-lib.sh
          sh ./setup/unish-lib.sh
      
      - name: Setup Lime for Android
        run: |
          haxelib run lime setup android
          haxelib run lime config ANDROID_SDK $ANDROID_SDK_ROOT
          haxelib run lime config ANDROID_NDK_ROOT $ANDROID_SDK_ROOT/ndk/27.0.12077973
          haxelib run lime config JAVA_HOME $JAVA_HOME
      
      - name: Skip SScript setup mode
        run: |
          echo -n 'oy9:showMacroty8:loopCosti25y10:includeAllfg' > ~/settings.cocoa
          cat ~/settings.cocoa
      
      - name: Create Version Tag
        run: echo "${{github.run_id}}" > VERSION
      
      - name: Clean old build artifacts only
        run: |
          rm -rf export
          rm -rf build
          rm -rf ~/.gradle
      
      - name: Compile
        run: haxelib run lime build android --app-version="4.0.0-${{ github.run_id}}" -D officialBuild -D HXCPP_IGNORE_WARNINGS
      
      - name: Publish Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: androidBuild
          path: export/release/android/bin

  buildiOS:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4.1.7

      - uses: krdlab/setup-haxe@master
        with:
          haxe-version: 4.3.4
      
      - name: Install Haxelib
        run: |
          haxelib setup ~/haxelib
          haxelib install hxcpp > /dev/null --quiet
          chmod +x ./setup/unish-lib.sh
          sh ./setup/unish-lib.sh
      
      - name: Skip SScript setup mode
        run: |
          echo -n 'oy9:showMacroty8:loopCosti25y10:includeAllfg' > ~/settings.cocoa
          cat ~/settings.cocoa
      
      - name: Create Version Tag
        run: echo "${{github.run_id}}" > VERSION
      
      - name: Compile iOS (No Code Signing)
        run: haxelib run lime build ios -arm64 -nosign --app-version="4.0.0-${{ github.run_id}}" -D officialBuild -D HXCPP_IGNORE_WARNINGS
      
      - name: Make IPA
        run: |
          cd export/release/ios/build/Release-iphoneos
          rm -rf Payload
          mkdir Payload
          mv *.app Payload
          zip -r PlusEngine.ipa Payload
      
      - name: Publish Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: iOSBuild
          path: export/release/ios/build/Release-iphoneos/*.ipa